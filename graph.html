<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flowpad - Dashboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#1a1a1a;background-image:linear-gradient(rgba(255,255,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.03) 1px,transparent 1px);background-size:20px 20px;color:#fff;overflow:hidden}
    .header{position:fixed;inset:0 0 auto 0;height:60px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border-bottom:1px solid #333;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:1000}
    .logo{font-size:1.5rem;font-weight:700;background:linear-gradient(45deg,#fff,#ccc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .user-info{display:flex;align-items:center;gap:15px}
    .signout-btn{background:#333;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer}
    .sidebar{position:fixed;left:0;top:60px;bottom:0;width:300px;background:rgba(0,0,0,.8);backdrop-filter:blur(20px);border-right:1px solid #333;overflow-y:auto}
    .sidebar-content{padding:20px}
    .section-title{font-size:1.1rem;font-weight:600;margin-bottom:15px}
    .new-graph-btn{background:#4CAF50;color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;width:100%;font-size:1rem;margin-bottom:20px}
    .graph-item{background:rgba(255,255,255,.05);border:1px solid #333;border-radius:8px;padding:15px;margin-bottom:10px;cursor:pointer}
    .graph-title{font-weight:600;margin-bottom:5px}
    .graph-meta{font-size:.8rem;color:#888}
    .canvas-container{position:fixed;left:300px;top:60px;right:0;bottom:0;overflow:hidden}
    .canvas{width:100%;height:100%;background-image:linear-gradient(rgba(255,255,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.03) 1px,transparent 1px);background-size:20px 20px;position:relative}
    .tile{position:absolute;background:#fff;color:#000;border:2px solid #333;border-radius:8px;padding:15px;min-width:120px;min-height:80px;cursor:move;user-select:none;box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .tile-title,.tile-content{border:none;background:transparent;width:100%;outline:none;font-family:inherit}
    .tile-title{font-weight:600;margin-bottom:8px;font-size:.9rem}
    .tile-content{font-size:.8rem;line-height:1.4;min-height:40px}
    .connection{position:absolute;pointer-events:none;z-index:5}
    .connection-line{stroke:#4CAF50;stroke-width:2;fill:none;marker-end:url(#arrowhead)}
    .toolbar{position:fixed;top:70px;right:20px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border:1px solid #333;border-radius:12px;padding:15px;z-index:1000;min-width:200px}
    .tool-label{color:#ccc;font-size:.8rem;margin-bottom:8px;text-align:center;font-weight:500}
    .tool-btn{background:#333;color:#fff;border:none;padding:8px;border-radius:6px;cursor:pointer;margin:2px;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;font-size:1rem}
    .notification{position:fixed;top:80px;right:20px;background:#4CAF50;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:10000;transform:translateX(400px);transition:.3s transform;max-width:300px}
    .notification.show{transform:translateX(0)}
    .notification.error{background:#f44336}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">Flowpad</div>
    <div class="user-info">
      <span id="userName">User</span>
      <button class="signout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-content">
      <button class="new-graph-btn" onclick="createNewGraph()">+ New Graph</button>
      <div class="section-title">My Graphs</div>
      <div id="ownGraphs"></div>
      <div class="section-title">Shared With Me</div>
      <div id="sharedGraphs"></div>
      <div class="section-title" id="shareHeader" style="display:none;">Share Current Graph</div>
      <input type="email" id="shareEmail" placeholder="Enter email address" style="display:none;width:100%;padding:8px;border-radius:6px;border:1px solid #555;color:#000"/>
      <button id="shareBtn" style="display:none;margin-top:8px" class="new-graph-btn" onclick="shareGraph()">Share</button>
    </div>
  </div>

  <div class="canvas-container">
    <div class="canvas" id="canvas"></div>
  </div>

  <div id="notification" class="notification"></div>

  <svg style="position:absolute;width:0;height:0">
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#4CAF50"></polygon>
      </marker>
    </defs>
  </svg>

  <script>
    let currentUser=null,currentGraph=null,tiles=[],connections=[],selectedTile=null,isDragging=false,dragOffset={x:0,y:0};
    const canvas=document.getElementById('canvas');

    document.addEventListener('DOMContentLoaded', init);

    async function init(){
      await checkAuth();
      await loadGraphs();
      setupCanvas();
    }

    async function checkAuth(){
      const token=localStorage.getItem('flowpad_token');
      const user=localStorage.getItem('flowpad_user');
      if(!token||!user){ window.location.href='/'; return; }
      currentUser=JSON.parse(user);
      document.getElementById('userName').textContent=currentUser.name;
      const ok = await fetch('/api/graphs', { headers:{Authorization:`Bearer ${token}`} }).then(r=>r.ok).catch(()=>false);
      if(!ok){ localStorage.clear(); window.location.href='/'; }
    }

    function signOut(){ localStorage.clear(); window.location.href='/'; }

    function el(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; }

    async function loadGraphs(){
      const token=localStorage.getItem('flowpad_token');
      const res=await fetch('/api/graphs', { headers:{Authorization:`Bearer ${token}`} });
      if(!res.ok) return;
      const data=await res.json();
      renderGraphList(data.own, 'ownGraphs');
      renderGraphList(data.shared, 'sharedGraphs');
    }

    function renderGraphList(list, id){
      const c=document.getElementById(id); c.innerHTML='';
      list.forEach(g=>{
        const item=el(`<div class="graph-item"><div class="graph-title">${g.title}</div><div class="graph-meta">Updated: ${new Date(g.updated_at).toLocaleString()}</div></div>`);
        item.addEventListener('click', ()=>loadGraph(g));
        c.appendChild(item);
      });
    }

    async function createNewGraph(){
      const title=prompt('Enter graph title:');
      if(!title) return;
      const token=localStorage.getItem('flowpad_token');
      const res=await fetch('/api/graphs',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${token}`},body:JSON.stringify({title,data:{tiles:[],connections:[]}})});
      if(!res.ok) return;
      const graph=await res.json();
      await loadGraphs();
      loadGraph(graph);
    }

    function loadGraph(graph){
      currentGraph=graph;
      tiles=(graph.data?.tiles||[]).map(t=>createTile(t.x,t.y,t.title,t.content));
      connections=graph.data?.connections||[];
      document.getElementById('shareHeader').style.display='block';
      document.getElementById('shareEmail').style.display='block';
      document.getElementById('shareBtn').style.display='inline-block';
      renderCanvas();
    }

    function setupCanvas(){
      canvas.addEventListener('mousedown', e=>{
        const tile=e.target.closest('.tile');
        if(tile){ startDragging(e,tile); }
      });
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('mouseup', ()=>{ isDragging=false; selectedTile=null; });
    }

    function createTile(x=100,y=100,title='',content=''){
      const tile=document.createElement('div');
      tile.className='tile';
      tile.style.left=x+'px'; tile.style.top=y+'px';
      tile.innerHTML=`
        <textarea class="tile-title" placeholder="Title">${title||''}</textarea>
        <textarea class="tile-content" placeholder="Content">${content||''}</textarea>`;
      tile.querySelectorAll('textarea').forEach(t=>t.addEventListener('input', scheduleSave));
      tile.addEventListener('mousedown', e=>startDragging(e,tile));
      return tile;
    }

    function startDragging(e,tile){
      isDragging=true; selectedTile=tile;
      const r=tile.getBoundingClientRect();
      dragOffset.x=e.clientX-r.left; dragOffset.y=e.clientY-r.top;
    }

    function handleMouseMove(e){
      if(!isDragging||!selectedTile) return;
      const rect=canvas.getBoundingClientRect();
      const x=e.clientX-rect.left-dragOffset.x;
      const y=e.clientY-rect.top-dragOffset.y;
      selectedTile.style.left=x+'px';
      selectedTile.style.top=y+'px';
      scheduleSave();
    }

    function renderCanvas(){
      canvas.innerHTML='';
      tiles.forEach(t=>canvas.appendChild(t));
      // connections drawing omitted for brevity
    }

    async function shareGraph(){
      if(!currentGraph) return;
      const email=document.getElementById('shareEmail').value.trim();
      if(!email) return notify('Please enter an email','error');
      const token=localStorage.getItem('flowpad_token');
      const res=await fetch(`/api/graphs/${currentGraph.id}/share`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${token}`},body:JSON.stringify({email})});
      notify(res.ok?'Graph shared successfully':'Failed to share graph', res.ok?'success':'error');
      if(res.ok) document.getElementById('shareEmail').value='';
    }

    let saveTimer;
    function scheduleSave(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveGraph, 500); }

    async function saveGraph(){
      if(!currentGraph) return;
      const token=localStorage.getItem('flowpad_token');
      const data={
        tiles:[...canvas.querySelectorAll('.tile')].map(t=>({
          x:parseInt(t.style.left)||0,
          y:parseInt(t.style.top)||0,
          title:t.querySelector('.tile-title').value||'',
          content:t.querySelector('.tile-content').value||''
        })),
        connections
      };
      await fetch(`/api/graphs/${currentGraph.id}`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:`Bearer ${token}`},body:JSON.stringify({title:currentGraph.title,data})});
    }

    function notify(msg,type='success',ms=2500){
      const n=document.getElementById('notification');
      n.textContent=msg; n.className=`notification ${type}`; n.classList.add('show');
      setTimeout(()=>n.classList.remove('show'), ms);
    }
  </script>
</body>
</html>
